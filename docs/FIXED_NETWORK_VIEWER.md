# Виправлений інтерактивний візуалізатор мережі

## Огляд

Виправлений інтерактивний візуалізатор мережі (`FixedInteractiveNetworkViewer`) - це покращена версія інтерактивного візуалізатора з виправленими проблемами відображення зв'язків, автоматичним розташуванням вузлів та коректним збереженням у базу даних.

## Виправлені проблеми

### 1. **Зв'язки між вузлами відображаються коректно**

**Проблема:** Граф не будувався, бо дані зі словника не конвертувалися у формат ребер.

**Рішення:**
- Реалізовано конвертацію словника Python у NetworkX граф
- Автоматичне оновлення графу при змінах структури мережі
- Правильне відображення всіх зв'язків

```python
def _update_networkx_graph(self):
    """Обновляет NetworkX граф из словаря Python"""
    self.G.clear()
    
    # Добавляем узлы
    for node_id in self.network_dict.keys():
        self.G.add_node(node_id)
    
    # Добавляем связи
    for from_node, connections in self.network_dict.items():
        for to_node in connections:
            if from_node < to_node:  # Избегаем дублирования
                self.G.add_edge(from_node, to_node)
    
    # Вычисляем позиции с помощью force-directed layout
    if len(self.G.nodes()) > 0:
        self.pos = nx.spring_layout(self.G, k=3, iterations=50)
```

### 2. **Вузли автоматично розташовуються в просторі**

**Проблема:** Усі вузли стояли в один ряд через статичний layout.

**Рішення:**
- Реалізовано force-directed layout з використанням `nx.spring_layout()`
- Вузли автоматично розташовуються динамічно
- Врахування відстаней та зв'язків при розташуванні

```python
# Вычисляем позиции с помощью force-directed layout
if len(self.G.nodes()) > 0:
    self.pos = nx.spring_layout(self.G, k=3, iterations=50)
```

### 3. **Розміри вузлів адаптовані під масштаб**

**Проблема:** Занадто великі вузли та шрифти.

**Рішення:**
- Зменшено розмір вузлів з 0.3 до 0.15
- Зменшено розмір шрифту з 8 до 6
- Зменшено розмір інформації про ступінь з 6 до 4
- Зменшено товщину зв'язків з 2 до 1.5

```python
# Зменшені розміри вузлів
node_size = 0.15  # Зменшено з 0.3 до 0.15

# Зменшений шрифт
fontsize=6, fontweight='bold'  # Зменшено з 8 до 6

# Зменшена інформація про ступінь
fontsize=4, color='yellow'  # Зменшено з 6 до 4
```

### 4. **Мережа зберігається у .db як реальний Python-словник**

**Проблема:** Мережа не зберігалася у файлі `.db` або запис був некоректний.

**Рішення:**
- Реалізовано автоматичне збереження структури мережі у Python-словнику
- Використання стандартних засобів Python (`repr()` та `eval()`)
- Автоматичне оновлення файлу при змінах структури мережі

```python
def _save_network_to_db(self, filename):
    """Сохраняет сеть в базу данных у форматі Python словника"""
    try:
        # Використовуємо стандартні засоби Python для збереження словника
        with open(filename, "w", encoding='utf-8') as f:
            f.write(repr(self.network_dict))
    except Exception as e:
        raise Exception(f"Помилка збереження в файл: {e}")

def render_network_from_db(self, filename):
    """Загружает сеть из .db и строит визуализацию"""
    try:
        # Загружаем данные из файла
        with open(filename, "r", encoding='utf-8') as f:
            data = f.read()
            self.network_dict = eval(data)
        
        # Обновляем NetworkX граф
        self._update_networkx_graph()
        
        # Обновляем отображение
        self._draw_network()
        
    except Exception as e:
        raise Exception(f"Помилка завантаження з файлу: {e}")
```

## Формат даних

### Структура мережі в пам'яті:
```python
{
    'a': ['b', 'c'],
    'b': ['a', 'c', 'd'],
    'c': ['a', 'b', 'd'],
    'd': ['b', 'c', 'e'],
    'e': ['d', 'f'],
    'f': ['e']
}
```

### Формат збереження в .db:
```python
# Використовується repr() для збереження словника
"{'a': ['b', 'c'], 'b': ['a', 'c', 'd'], 'c': ['a', 'b', 'd'], 'd': ['b', 'c', 'e'], 'e': ['d', 'f'], 'f': ['e']}"
```

## Технічні деталі

### Архітектура

```python
class FixedInteractiveNetworkViewer:
    """Виправлений інтерактивний візуалізатор топології мережі"""
    
    def __init__(self, parent, topology_frame=None):
        # Данные для редактирования в форматі словника Python
        self.network_dict = {}  # {'a': ['b', 'c'], 'b': ['c'], 'c': []}
        
        # NetworkX граф для візуалізації
        self.G = nx.Graph()
        self.pos = {}  # Позиції вузлів
        
    def _update_networkx_graph(self):
        """Обновляет NetworkX граф из словаря Python"""
        
    def render_network_from_db(self, filename):
        """Загружает сеть из .db и строит визуализацию"""
        
    def _save_network_to_db(self, filename):
        """Сохраняет сеть в базу данных у форматі Python словника"""
```

### Ключові методи

1. **`_update_networkx_graph()`** - оновлює NetworkX граф з словника Python
2. **`render_network_from_db()`** - завантажує мережу з .db та будує візуалізацію
3. **`_save_network_to_db()`** - зберігає мережу в базу даних у форматі Python словника
4. **`_draw_network()`** - відображає мережу з правильними зв'язками та позиціями

## Використання

### Інтеграція з основним додатком

Виправлений візуалізатор автоматично інтегрується в головне вікно:

```python
# В main_window.py
try:
    from .fixed_interactive_network_viewer import FixedInteractiveNetworkViewer
    self.network_viewer = FixedInteractiveNetworkViewer(self, self.topology_frame)
except ImportError:
    # Fallback на інші візуалізатори
    ...
```

### Програмне використання

```python
from src.gui.fixed_interactive_network_viewer import FixedInteractiveNetworkViewer

# Створення візуалізатора
viewer = FixedInteractiveNetworkViewer(parent_window)

# Завантаження з бази даних
viewer.render_network_from_db("my_network.db")

# Збереження в базу даних
viewer._save_network_to_db("my_network.db")

# Отримання даних мережі
network_data = viewer.get_network_data()
```

## Режими редагування

### 1. Перегляд
- Виділення вузлів та зв'язків
- Перетягування вузлів
- Масштабування колесиком миші

### 2. Додати вузол
- Клік по холсту для додавання вузла
- Автоматичне оновлення позицій при зміні зв'язків

### 3. Додати зв'язок
- Клік по двох вузлах для створення зв'язку
- Автоматичне оновлення графу

### 4. Видалити
- Клік по елементу для видалення
- Автоматичне оновлення структури

## Аналіз та експорт

### Аналіз зв'язності
- Перевірка зв'язності мережі
- Обчислення діаметра та середньої довжини шляху
- Визначення компонент зв'язності

### Експорт для аналізу надійності
- Перетворення даних у формат для аналізу надійності
- Інтеграція з модулем аналізу надійності
- Підтримка всіх функцій базового візуалізатора

## Налаштування

### Автоматичне збереження
```python
# Увімкнення/вимкнення автоматичного збереження
viewer.auto_save_enabled = True
viewer.db_filename = "my_network.db"
```

### Анімації
```python
# Увімкнення/вимкнення анімацій
viewer.animation_enabled = True
```

## Сумісність

Виправлений візуалізатор повністю сумісний з базовим інтерактивним візуалізатором:

- Всі методи базового візуалізатора збережені
- Підтримка всіх існуючих функцій
- Зворотна сумісність з існуючим кодом

## Тестування

### Запуск тестів
```bash
python scripts/tests/test_fixed_network_viewer.py
```

### Демонстрація
```bash
python scripts/demos/demo_fixed_network_viewer.py
```

## Переваги

1. **Коректне відображення** - всі зв'язки відображаються правильно
2. **Автоматичне розташування** - вузли розташовуються динамічно
3. **Адаптовані розміри** - вузли та шрифти мають оптимальні розміри
4. **Надійне збереження** - мережа зберігається у правильному форматі
5. **Автоматичне оновлення** - зміни автоматично відображаються
6. **Повна сумісність** - всі існуючі функції збережені

## Обмеження

1. **Продуктивність** - force-directed layout може бути повільним для великих мереж
2. **Пам'ять** - NetworkX граф займає додаткову пам'ять
3. **Файли** - використовується простий текстовий формат (не підходить для великих обсягів)

## Майбутні покращення

1. **Оптимізація** - покращення продуктивності для великих мереж
2. **Розширені layout** - додаткові алгоритми розташування
3. **Інтерактивність** - більше можливостей взаємодії
4. **Експорт** - збереження у різні формати
5. **3D візуалізація** - тривимірне відображення мережі
